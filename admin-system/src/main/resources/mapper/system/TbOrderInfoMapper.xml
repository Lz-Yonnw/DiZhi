<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.TbOrderInfoMapper">
    <resultMap id="TbOrderDerails" type="com.ruoyi.system.domain.TbOrderDerails">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="orderInfoId" column="order_info_id"/>
        <result property="mallId" column="mall_id"/>
        <result property="storeId" column="store_id"/>
        <result property="size" column="size"/>
        <result property="colour" column="colour"/>
        <result property="quantity" column="quantity"/>
        <result property="amount" column="amount"/>
        <result property="image" column="image"/>
    </resultMap>
    <resultMap type="com.ruoyi.system.domain.TbOrderInfo" id="TbOrderInfoResult">
        <result property="id"    column="id"    />
        <result property="payAmount"    column="pay_amount"    />
        <result property="amount"    column="amount"    />
        <result property="orderSn"    column="order_sn"    />
        <result property="modelType"    column="model_type"    />
        <result property="storeId"    column="store_id"    />
        <result property="mallId"    column="mall_id"    />
        <result property="userId"    column="user_id"    />
        <result property="status"    column="status"    />
        <result property="createTime"    column="create_time"    />
        <result property="payType"    column="pay_type"    />
        <result property="payAccount"    column="pay_account"    />
        <result property="address"    column="address"    />
        <result property="phone"    column="phone"    />
        <result property="consignee"    column="consignee"    />
        <result property="remark"    column="remark"    />
        <result property="payTime"    column="pay_time"    />
        <result property="delTime"    column="del_time"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="delBy"    column="del_by"    />
        <result property="timeOutFlag"    column="time_out_flag"    />
        <result property="updateTime"    column="update_time"    />
        <result property="clothesJson" column="clothes_json"/>
        <result property="userName" column="user_nickname"/>
        <result property="storeName" column="store_name"/>
        <result property="mallName" column="mall_name"/>
    </resultMap>
    <sql id="selectTbOrderInfoVo">
        select id, pay_amount, amount, order_sn, model_type, store_id, mall_id, user_id, `status`, create_time, pay_type, pay_account, address, phone, consignee, remark, pay_time, del_time, del_flag, del_by, time_out_flag, update_time,clothes_json from tb_order_info
    </sql>

    <sql id="selectTbOrderDescInfoVo">
        select tborder.id,tborder.order_sn,tborder.pay_amount, tborder.model_type,tborder.`status`, tborder.create_time, tborder.pay_type, tborder.pay_account, tborder.phone, tborder.consignee, tborder.pay_time, tborder.del_time, tborder.del_flag, tborder.del_by, tborder.time_out_flag, tborder.update_time,tbuser.user_nickname,tbstore.name as 'store_name',tbmall.name as 'mall_name' from tb_order_info tborder
        LEFT JOIN tb_user_info tbuser
        on tborder.user_id=tbuser.id
        LEFT JOIN tb_store tbstore
        on tbstore.id=tborder.store_id
        LEFT JOIN tb_mall tbmall
        on tborder.mall_id = tbmall.id
    </sql>

    <select id="selectTbOrderInfoList" parameterType="com.ruoyi.system.domain.TbOrderDerails" resultMap="TbOrderInfoResult">
        <include refid="selectTbOrderDescInfoVo"/>
        <where>
            <if test="payAmount != null "> and pay_amount = #{payAmount}</if>
            <if test="amount != null "> and amount = #{amount}</if>
            <if test="orderSn != null  and orderSn != ''"> and order_sn = #{orderSn}</if>
            <if test="modelType != null  and modelType != ''"> and model_type = #{modelType}</if>
            <if test="storeId != 0 "> and store_id = #{storeId}</if>
            <if test="mallId != 0 "> and mall_id = #{mallId}</if>
            <if test="userId != 0 "> and user_id = #{userId}</if>
            <if test="status != 0"> and tborder.status = #{status}</if>
            <if test="payType != 0 "> and pay_type = #{payType}</if>
            <if test="payAccount != null  and payAccount != ''"> and pay_account = #{payAccount}</if>
            <if test="address != null  and address != ''"> and address = #{address}</if>
            <if test="phone != null  and phone != ''"> and phone = #{phone}</if>
            <if test="consignee != null  and consignee != ''"> and consignee = #{consignee}</if>
            <if test="payTime != null "> and pay_time = #{payTime}</if>
            <if test="delTime != null "> and del_time = #{delTime}</if>
            <if test="delBy != null  and delBy != ''"> and del_by = #{delBy}</if>
            <if test="timeOutFlag != 0 "> and time_out_flag = #{timeOutFlag}</if>
            <if test="delFlag != null "> and del_flag = #{delFlag}</if>
            <if test="clothesJson != null "> and clothes_json = #{clothesJson}</if>
        </where>
    </select>
    <sql id="selectOrderInfo" >
        select id,pay_amount,amount,order_sn,model_type,store_id,mall_id,user_id,`status`,create_time,pay_type,pay_account,address,phone,consignee,remark,pay_time,del_time,del_flag,del_by,time_out_flag,update_time,clothes_json from tb_order_info
    </sql>
    <sql id="selectIds">
        select id from tb_order_info
    </sql>
    <insert id="insert" parameterType="com.ruoyi.system.domain.TbOrderInfo">
        insert into tb_order_info
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="payAmount != null">pay_amount,</if>
            <if test="amount != null">amount,</if>
            <if test="orderSn != null and orderSn != ''">order_sn,</if>
            <if test="modelType != null">model_type,</if>
            <if test="storeId != null">store_id,</if>
            <if test="mallId != null">mall_id,</if>
            <if test="userId != null">user_id,</if>
            <if test="status != null">status,</if>
            <if test="createTime != null">create_time,</if>
            <if test="payType != null">pay_type,</if>
            <if test="payAccount != null">pay_account,</if>
            <if test="address != null and address != ''">address,</if>
            <if test="phone != null and phone != ''">phone,</if>
            <if test="consignee != null and consignee != ''">consignee,</if>
            <if test="remark != null">remark,</if>
            <if test="payTime != null">pay_time,</if>
            <if test="delTime != null">del_time,</if>
            <if test="delFlag != null">del_flag,</if>
            <if test="delBy != null">del_by,</if>
            <if test="timeOutFlag != null">time_out_flag,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="clothesJson != null">clothes_json,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="payAmount != null">#{payAmount},</if>
            <if test="amount != null">#{amount},</if>
            <if test="orderSn != null and orderSn != ''">#{orderSn},</if>
            <if test="modelType != null">#{modelType},</if>
            <if test="storeId != null">#{storeId},</if>
            <if test="mallId != null">#{mallId},</if>
            <if test="userId != null">#{userId},</if>
            <if test="status != null">#{status},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="payType != null">#{payType},</if>
            <if test="payAccount != null">#{payAccount},</if>
            <if test="address != null and address != ''">#{address},</if>
            <if test="phone != null and phone != ''">#{phone},</if>
            <if test="consignee != null and consignee != ''">#{consignee},</if>
            <if test="remark != null">#{remark},</if>
            <if test="payTime != null">#{payTime},</if>
            <if test="delTime != null">#{delTime},</if>
            <if test="delFlag != null">#{delFlag},</if>
            <if test="delBy != null">#{delBy},</if>
            <if test="timeOutFlag != null">#{timeOutFlag},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="clothesJson != null">#{clothesJson},</if>
        </trim>
    </insert>
    <select id="selectOrderInfo" resultType="com.ruoyi.system.domain.TbOrderInfo">
        <include refid="selectOrderInfo"></include>
        <where>
            <if test="orderInfoId !=null">id = #{orderInfoId}</if>
        </where>
    </select>
    <select id="selectOrderInfoPhones" resultType="com.ruoyi.system.domain.TbOrderInfo">
        <include refid="selectOrderInfo"></include>
        <where>
            <if test="userId != null and userId != ''"> and user_id = #{userId}</if>
            <if test="status != null">and status = #{status}</if>
            <if test="orderSn != null and orderSn != ''">and order_sn = #{orderSn}</if>
        </where>
    </select>

    <select id="selectTbOrderInfoListByUserId" resultType="com.ruoyi.system.domain.TbOrderInfo">
        <include refid="selectOrderInfo"></include>
        <where>
            <if test="userId != null and userId != ''"> and user_id = #{userId}</if>
            <if test="status != 0">and status = #{status}</if>
            <if test="orderSn != null and orderSn != ''">and order_sn = #{orderSn}</if>
        </where>
    </select>

    <select id="selectOrderSn" resultType="com.ruoyi.system.domain.TbOrderInfo">
        <include refid="selectOrderInfo"/> where order_sn=#{s}
    </select>

    <update id="updateTbOrderInfo" parameterType="com.ruoyi.system.domain.TbOrderInfo">
        update tb_order_info
        <trim prefix="SET" suffixOverrides=",">
            <if test="payAmount != null">pay_amount = #{payAmount},</if>
            <if test="amount != null">amount = #{amount},</if>
            <if test="orderSn != null and orderSn != ''">order_sn = #{orderSn},</if>
            <if test="modelType != null">model_type = #{modelType},</if>
            <if test="storeId != null">store_id = #{storeId},</if>
            <if test="mallId != null">mall_id = #{mallId},</if>
            <if test="userId != null">user_id = #{userId},</if>
            <if test="status != null">status = #{status},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="payType != null">pay_type = #{payType},</if>
            <if test="payAccount != null">pay_account = #{payAccount},</if>
            <if test="address != null and address != ''">address = #{address},</if>
            <if test="phone != null and phone != ''">phone = #{phone},</if>
            <if test="consignee != null and consignee != ''">consignee = #{consignee},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="payTime != null">pay_time = #{payTime},</if>
            <if test="delTime != null">del_time = #{delTime},</if>
            <if test="delFlag != null">del_flag = #{delFlag},</if>
            <if test="delBy != null">del_by = #{delBy},</if>
            <if test="timeOutFlag != null">time_out_flag = #{timeOutFlag},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="clothesJson != null">clothes_json = #{clothesJson},</if>
        </trim>
        where id = #{id}
    </update>

    <update id="updateTbOrderInfoStatus">
        update tb_order_info set status = #{status} where id = #{id}
    </update>

    <!-- 删除订单 -->
    <delete id="deleteTbOrderInfoById" >
         update tb_order_info set del_time=now(),del_flag=1,del_by=#{delBy} where id=#{orderInfoId}

    </delete>
</mapper>
